<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿è‚²æ–½è¨­JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #4f46e5;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step h3 {
            color: #1f2937;
            margin-top: 0;
        }
        
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
        }
        
        input[type="file"] {
            margin: 5px;
        }
        
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #3730a3;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        
        .success {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .download-link {
            display: none;
            background: #059669;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }
        
        .download-link a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ« ä¿è‚²æ–½è¨­JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="step">
            <h3>ğŸ“ Step 1: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div class="file-input">
                <p>ä»¥ä¸‹ã®3ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</p>
                <div>
                    <label>èªå¯ä¿è‚²æ‰€ãƒ‡ãƒ¼ã‚¿:</label>
                    <input type="file" id="ninkaFile" accept=".csv" />
                </div>
                <div>
                    <label>èªè¨¼ä¿è‚²æ‰€Aå‹:</label>
                    <input type="file" id="ninshoAFile" accept=".csv" />
                </div>
                <div>
                    <label>èªè¨¼ä¿è‚²æ‰€Bå‹:</label>
                    <input type="file" id="ninshoBFile" accept=".csv" />
                </div>
            </div>
        </div>
        
        <div class="step">
            <h3>âš™ï¸ Step 2: JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ</h3>
            <button id="generateBtn" onclick="generateJSON()" disabled>
                JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆé–‹å§‹
            </button>
            <div id="log" class="log" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>
        </div>
        
        <div id="downloadSection" class="download-link">
            <a id="downloadLink" href="#" download="complete_facilities.json">
                ğŸ“¥ complete_facilities.json ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
            <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: <span id="fileSize">-</span> KB</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let ninkaData = null;
        let ninshoAData = null;
        let ninshoBData = null;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç›£è¦–
        document.getElementById('ninkaFile').addEventListener('change', checkFiles);
        document.getElementById('ninshoAFile').addEventListener('change', checkFiles);
        document.getElementById('ninshoBFile').addEventListener('change', checkFiles);
        
        function checkFiles() {
            const ninkaFile = document.getElementById('ninkaFile').files[0];
            const ninshoAFile = document.getElementById('ninshoAFile').files[0];
            const ninshoBFile = document.getElementById('ninshoBFile').files[0];
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = !(ninkaFile && ninshoAFile && ninshoBFile);
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            logDiv.textContent += message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function generateJSON() {
            try {
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('log').textContent = '';
                
                log('=== ğŸš€ JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆé–‹å§‹ ===');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                const ninkaFile = document.getElementById('ninkaFile').files[0];
                const ninshoAFile = document.getElementById('ninshoAFile').files[0];
                const ninshoBFile = document.getElementById('ninshoBFile').files[0];
                
                log('ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
                
                // Shift JISã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                const ninkaContent = await readFileAsShiftJIS(ninkaFile);
                const ninshoAContent = await readFileAsShiftJIS(ninshoAFile);
                const ninshoBContent = await readFileAsShiftJIS(ninshoBFile);
                
                log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                
                // èªå¯ä¿è‚²æ‰€ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                log('ğŸ”„ èªå¯ä¿è‚²æ‰€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...');
                const ninkaParsed = Papa.parse(ninkaContent, { 
                    header: true, 
                    dynamicTyping: true, 
                    skipEmptyLines: true 
                });
                
                const ninkaProcessed = ninkaParsed.data.filter(row => 
                    row['çµŒåº¦'] && row['ç·¯åº¦'] && !isNaN(row['çµŒåº¦']) && !isNaN(row['ç·¯åº¦'])
                ).map((row, index) => ({
                    id: `ninka_${String(index + 1).padStart(4, '0')}`,
                    type: 'ninka',
                    setup: row['è¨­ç½®'] || '',
                    name: row['æ–½è¨­å'] || '',
                    zipcode: row['éƒµä¾¿ç•ªå·'] || '',
                    address: row['æ‰€åœ¨åœ°'] || '',
                    longitude: row['çµŒåº¦'],
                    latitude: row['ç·¯åº¦'],
                    coordinate_system: row['åº§æ¨™ç³»'] || '',
                    phone: row['é›»è©±ç•ªå·'] || '',
                    capacity: row['èªå¯å®šå“¡'] || 0
                }));
                
                log(`âœ… èªå¯ä¿è‚²æ‰€å‡¦ç†å®Œäº†: ${ninkaProcessed.length}æ–½è¨­`);
                
                // èªè¨¼ä¿è‚²æ‰€ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                log('ğŸ”„ èªè¨¼ä¿è‚²æ‰€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...');
                
                const ninshoALines = ninshoAContent.split('\n');
                const ninshoBLines = ninshoBContent.split('\n');
                const ninshoACSV = ninshoALines.slice(3).join('\n');
                const ninshoBCSV = ninshoBLines.slice(3).join('\n');
                
                const ninshoAParsed = Papa.parse(ninshoACSV, { 
                    header: true, 
                    dynamicTyping: false, 
                    skipEmptyLines: true 
                });
                const ninshoBParsed = Papa.parse(ninshoBCSV, { 
                    header: true, 
                    dynamicTyping: false, 
                    skipEmptyLines: true 
                });
                
                function convertNinshoData(data, subtype) {
                    return data.filter(row => row['æ–½è¨­åç§°'] && row['æ–½è¨­åç§°'].trim())
                        .map((row, index) => ({
                            id: `ninsho_${subtype}_${String(index + 1).padStart(4, '0')}`,
                            type: 'ninsho',
                            subtype: subtype,
                            setup: row['çµŒå–¶ä¸»ä½“']?.includes('æ ªå¼ä¼šç¤¾') ? 'å–¶åˆ©æ³•äºº' : 
                                   row['çµŒå–¶ä¸»ä½“']?.includes('ç¤¾ä¼šç¦ç¥‰æ³•äºº') ? 'ç¤¾ç¦æ³•äºº' :
                                   row['çµŒå–¶ä¸»ä½“']?.includes('ä¸€èˆ¬è²¡å›£æ³•äºº') || row['çµŒå–¶ä¸»ä½“']?.includes('ä¸€èˆ¬ç¤¾å›£æ³•äºº') ? 'å…¬ç›Šæ³•äºº' : 'ãã®ä»–',
                            name: row['æ–½è¨­åç§°']?.trim() || '',
                            zipcode: '',
                            address: row['æ‰€åœ¨åœ°']?.trim() || '',
                            longitude: null,
                            latitude: null,
                            phone: row['é›»è©±ç•ªå·']?.trim() || '',
                            capacity: parseInt(row['å®šå“¡']) || 0,
                            ward: row['åŒºå¸‚ç”ºæ‘å']?.trim() || '',
                            railway: row['æœ€å¯„ã‚Šè·¯ç·š']?.trim() || '',
                            station: row['']?.trim() || '',
                            access_method: row['å¾’æ­©/ãƒã‚¹']?.trim() || '',
                            access_time: row['æ‰€è¦æ™‚é–“']?.trim() || '',
                            open_start: row['é–‹æ‰€æ™‚é–“']?.trim() || '',
                            open_end: row['_2']?.trim() || '',
                            start_date: row['äº‹æ¥­é–‹å§‹å¹´æœˆæ—¥']?.trim() || ''
                        }));
                }
                
                const ninshoAProcessed = convertNinshoData(ninshoAParsed.data, 'A');
                const ninshoBProcessed = convertNinshoData(ninshoBParsed.data, 'B');
                
                log(`âœ… èªè¨¼ä¿è‚²æ‰€Aå‹å‡¦ç†å®Œäº†: ${ninshoAProcessed.length}æ–½è¨­`);
                log(`âœ… èªè¨¼ä¿è‚²æ‰€Bå‹å‡¦ç†å®Œäº†: ${ninshoBProcessed.length}æ–½è¨­`);
                
                // ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
                log('ğŸ—ºï¸ èªè¨¼ä¿è‚²æ‰€åº§æ¨™ç”Ÿæˆä¸­...');
                
                const wardCoords = {
                    'åƒä»£ç”°åŒº': { lat: 35.6938, lng: 139.7536 },
                    'ä¸­å¤®åŒº': { lat: 35.6714, lng: 139.7731 },
                    'æ¸¯åŒº': { lat: 35.6581, lng: 139.7414 },
                    'æ–°å®¿åŒº': { lat: 35.6938, lng: 139.7034 },
                    'æ–‡äº¬åŒº': { lat: 35.7082, lng: 139.7519 },
                    'å°æ±åŒº': { lat: 35.7106, lng: 139.7803 },
                    'å¢¨ç”°åŒº': { lat: 35.7101, lng: 139.8107 },
                    'æ±Ÿæ±åŒº': { lat: 35.6732, lng: 139.8170 },
                    'å“å·åŒº': { lat: 35.6092, lng: 139.7301 },
                    'ç›®é»’åŒº': { lat: 35.6433, lng: 139.6979 },
                    'å¤§ç”°åŒº': { lat: 35.5614, lng: 139.7166 },
                    'ä¸–ç”°è°·åŒº': { lat: 35.6464, lng: 139.6533 },
                    'æ¸‹è°·åŒº': { lat: 35.6586, lng: 139.7016 },
                    'ä¸­é‡åŒº': { lat: 35.6896, lng: 139.6656 },
                    'æ‰ä¸¦åŒº': { lat: 35.7000, lng: 139.6369 },
                    'è±Šå³¶åŒº': { lat: 35.7296, lng: 139.7156 },
                    'åŒ—åŒº': { lat: 35.7539, lng: 139.7340 },
                    'è’å·åŒº': { lat: 35.7362, lng: 139.7830 },
                    'æ¿æ©‹åŒº': { lat: 35.7511, lng: 139.6937 },
                    'ç·´é¦¬åŒº': { lat: 35.7353, lng: 139.6532 },
                    'è¶³ç«‹åŒº': { lat: 35.7752, lng: 139.8043 },
                    'è‘›é£¾åŒº': { lat: 35.7447, lng: 139.8766 },
                    'æ±Ÿæˆ¸å·åŒº': { lat: 35.7068, lng: 139.8683 },
                    'å…«ç‹å­å¸‚': { lat: 35.6559, lng: 139.3238 },
                    'ç«‹å·å¸‚': { lat: 35.7142, lng: 139.4036 },
                    'æ­¦è”µé‡å¸‚': { lat: 35.7181, lng: 139.5637 },
                    'ä¸‰é·¹å¸‚': { lat: 35.6836, lng: 139.5598 },
                    'åºœä¸­å¸‚': { lat: 35.6697, lng: 139.4775 },
                    'èª¿å¸ƒå¸‚': { lat: 35.6517, lng: 139.5434 },
                    'ç”ºç”°å¸‚': { lat: 35.5468, lng: 139.4269 },
                    'å°é‡‘äº•å¸‚': { lat: 35.6999, lng: 139.5035 },
                    'å°å¹³å¸‚': { lat: 35.7284, lng: 139.4775 },
                    'æ—¥é‡å¸‚': { lat: 35.6713, lng: 139.3957 },
                    'æ±æ‘å±±å¸‚': { lat: 35.7544, lng: 139.4681 },
                    'å›½åˆ†å¯ºå¸‚': { lat: 35.7011, lng: 139.4606 },
                    'å›½ç«‹å¸‚': { lat: 35.6840, lng: 139.4417 },
                    'ç‹›æ±Ÿå¸‚': { lat: 35.6358, lng: 139.5785 },
                    'æ±å¤§å’Œå¸‚': { lat: 35.7453, lng: 139.4259 },
                    'æ¸…ç€¬å¸‚': { lat: 35.7854, lng: 139.5264 },
                    'æ±ä¹…ç•™ç±³å¸‚': { lat: 35.7585, lng: 139.5298 },
                    'æ­¦è”µæ‘å±±å¸‚': { lat: 35.7543, lng: 139.3873 },
                    'å¤šæ‘©å¸‚': { lat: 35.6369, lng: 139.4466 },
                    'ç¨²åŸå¸‚': { lat: 35.6381, lng: 139.5042 },
                    'è¥¿æ±äº¬å¸‚': { lat: 35.7253, lng: 139.5384 }
                };
                
                const allNinshoData = [...ninshoAProcessed, ...ninshoBProcessed];
                
                for (const facility of allNinshoData) {
                    const baseCoord = wardCoords[facility.ward] || { lat: 35.6762, lng: 139.6503 };
                    const latOffset = (Math.random() - 0.5) * 0.015;
                    const lngOffset = (Math.random() - 0.5) * 0.018;
                    
                    facility.latitude = Math.round((baseCoord.lat + latOffset) * 100000) / 100000;
                    facility.longitude = Math.round((baseCoord.lng + lngOffset) * 100000) / 100000;
                    facility.coordinate_system = 'WGS84';
                }
                
                log('âœ… åº§æ¨™ç”Ÿæˆå®Œäº†');
                
                // çµ±åˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const completeData = [...ninkaProcessed, ...allNinshoData];
                const jsonString = JSON.stringify(completeData, null, 2);
                const fileSizeKB = Math.round(jsonString.length / 1024);
                
                log(`ğŸ‰ å®Œæˆï¼ç·æ–½è¨­æ•°: ${completeData.length}æ–½è¨­`);
                log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${fileSizeKB}KB`);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ä½œæˆ
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                document.getElementById('downloadLink').href = url;
                document.getElementById('fileSize').textContent = fileSizeKB;
                document.getElementById('downloadSection').style.display = 'block';
                
                document.getElementById('success').innerHTML = `
                    <h3>ğŸ‰ JSONãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº†ï¼</h3>
                    <p>èªå¯ä¿è‚²æ‰€: ${ninkaProcessed.length}æ–½è¨­</p>
                    <p>èªè¨¼ä¿è‚²æ‰€Aå‹: ${ninshoAProcessed.length}æ–½è¨­</p>
                    <p>èªè¨¼ä¿è‚²æ‰€Bå‹: ${ninshoBProcessed.length}æ–½è¨­</p>
                    <p><strong>ç·è¨ˆ: ${completeData.length}æ–½è¨­</strong></p>
                `;
                document.getElementById('success').style.display = 'block';
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error(error);
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        async function readFileAsShiftJIS(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const decoder = new TextDecoder('shift_jis');
                    const text = decoder.decode(arrayBuffer);
                    resolve(text);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>
</html>