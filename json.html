<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保育施設JSONファイル生成ツール</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #4f46e5;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step h3 {
            color: #1f2937;
            margin-top: 0;
        }
        
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
        }
        
        input[type="file"] {
            margin: 5px;
        }
        
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #3730a3;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        
        .success {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .download-link {
            display: none;
            background: #059669;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }
        
        .download-link a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏫 保育施設JSONファイル生成ツール</h1>
        
        <div class="step">
            <h3>📁 Step 1: CSVファイルをアップロード</h3>
            <div class="file-input">
                <p>以下の3つのCSVファイルを選択してください：</p>
                <div>
                    <label>認可保育所データ:</label>
                    <input type="file" id="ninkaFile" accept=".csv" />
                </div>
                <div>
                    <label>認証保育所A型:</label>
                    <input type="file" id="ninshoAFile" accept=".csv" />
                </div>
                <div>
                    <label>認証保育所B型:</label>
                    <input type="file" id="ninshoBFile" accept=".csv" />
                </div>
            </div>
        </div>
        
        <div class="step">
            <h3>⚙️ Step 2: JSONファイル生成</h3>
            <button id="generateBtn" onclick="generateJSON()" disabled>
                JSONファイル生成開始
            </button>
            <div id="log" class="log" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>
        </div>
        
        <div id="downloadSection" class="download-link">
            <a id="downloadLink" href="#" download="complete_facilities.json">
                📥 complete_facilities.json をダウンロード
            </a>
            <p>ファイルサイズ: <span id="fileSize">-</span> KB</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let ninkaData = null;
        let ninshoAData = null;
        let ninshoBData = null;
        
        // ファイル選択監視
        document.getElementById('ninkaFile').addEventListener('change', checkFiles);
        document.getElementById('ninshoAFile').addEventListener('change', checkFiles);
        document.getElementById('ninshoBFile').addEventListener('change', checkFiles);
        
        function checkFiles() {
            const ninkaFile = document.getElementById('ninkaFile').files[0];
            const ninshoAFile = document.getElementById('ninshoAFile').files[0];
            const ninshoBFile = document.getElementById('ninshoBFile').files[0];
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = !(ninkaFile && ninshoAFile && ninshoBFile);
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            logDiv.textContent += message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function generateJSON() {
            try {
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('log').textContent = '';
                
                log('=== 🚀 JSONファイル生成開始 ===');
                
                // ファイル読み込み
                const ninkaFile = document.getElementById('ninkaFile').files[0];
                const ninshoAFile = document.getElementById('ninshoAFile').files[0];
                const ninshoBFile = document.getElementById('ninshoBFile').files[0];
                
                log('📁 CSVファイル読み込み中...');
                
                // Shift JISでファイルを読み込み
                const ninkaContent = await readFileAsShiftJIS(ninkaFile);
                const ninshoAContent = await readFileAsShiftJIS(ninshoAFile);
                const ninshoBContent = await readFileAsShiftJIS(ninshoBFile);
                
                log('✅ ファイル読み込み完了');
                
                // 認可保育所データ処理
                log('🔄 認可保育所データ処理中...');
                const ninkaParsed = Papa.parse(ninkaContent, { 
                    header: true, 
                    dynamicTyping: true, 
                    skipEmptyLines: true 
                });
                
                const ninkaProcessed = ninkaParsed.data.filter(row => 
                    row['経度'] && row['緯度'] && !isNaN(row['経度']) && !isNaN(row['緯度'])
                ).map((row, index) => ({
                    id: `ninka_${String(index + 1).padStart(4, '0')}`,
                    type: 'ninka',
                    setup: row['設置'] || '',
                    name: row['施設名'] || '',
                    zipcode: row['郵便番号'] || '',
                    address: row['所在地'] || '',
                    longitude: row['経度'],
                    latitude: row['緯度'],
                    coordinate_system: row['座標系'] || '',
                    phone: row['電話番号'] || '',
                    capacity: row['認可定員'] || 0
                }));
                
                log(`✅ 認可保育所処理完了: ${ninkaProcessed.length}施設`);
                
                // 認証保育所データ処理
                log('🔄 認証保育所データ処理中...');
                
                const ninshoALines = ninshoAContent.split('\n');
                const ninshoBLines = ninshoBContent.split('\n');
                const ninshoACSV = ninshoALines.slice(3).join('\n');
                const ninshoBCSV = ninshoBLines.slice(3).join('\n');
                
                const ninshoAParsed = Papa.parse(ninshoACSV, { 
                    header: true, 
                    dynamicTyping: false, 
                    skipEmptyLines: true 
                });
                const ninshoBParsed = Papa.parse(ninshoBCSV, { 
                    header: true, 
                    dynamicTyping: false, 
                    skipEmptyLines: true 
                });
                
                function convertNinshoData(data, subtype) {
                    return data.filter(row => row['施設名称'] && row['施設名称'].trim())
                        .map((row, index) => ({
                            id: `ninsho_${subtype}_${String(index + 1).padStart(4, '0')}`,
                            type: 'ninsho',
                            subtype: subtype,
                            setup: row['経営主体']?.includes('株式会社') ? '営利法人' : 
                                   row['経営主体']?.includes('社会福祉法人') ? '社福法人' :
                                   row['経営主体']?.includes('一般財団法人') || row['経営主体']?.includes('一般社団法人') ? '公益法人' : 'その他',
                            name: row['施設名称']?.trim() || '',
                            zipcode: '',
                            address: row['所在地']?.trim() || '',
                            longitude: null,
                            latitude: null,
                            phone: row['電話番号']?.trim() || '',
                            capacity: parseInt(row['定員']) || 0,
                            ward: row['区市町村名']?.trim() || '',
                            railway: row['最寄り路線']?.trim() || '',
                            station: row['']?.trim() || '',
                            access_method: row['徒歩/バス']?.trim() || '',
                            access_time: row['所要時間']?.trim() || '',
                            open_start: row['開所時間']?.trim() || '',
                            open_end: row['_2']?.trim() || '',
                            start_date: row['事業開始年月日']?.trim() || ''
                        }));
                }
                
                const ninshoAProcessed = convertNinshoData(ninshoAParsed.data, 'A');
                const ninshoBProcessed = convertNinshoData(ninshoBParsed.data, 'B');
                
                log(`✅ 認証保育所A型処理完了: ${ninshoAProcessed.length}施設`);
                log(`✅ 認証保育所B型処理完了: ${ninshoBProcessed.length}施設`);
                
                // ジオコーディング
                log('🗺️ 認証保育所座標生成中...');
                
                const wardCoords = {
                    '千代田区': { lat: 35.6938, lng: 139.7536 },
                    '中央区': { lat: 35.6714, lng: 139.7731 },
                    '港区': { lat: 35.6581, lng: 139.7414 },
                    '新宿区': { lat: 35.6938, lng: 139.7034 },
                    '文京区': { lat: 35.7082, lng: 139.7519 },
                    '台東区': { lat: 35.7106, lng: 139.7803 },
                    '墨田区': { lat: 35.7101, lng: 139.8107 },
                    '江東区': { lat: 35.6732, lng: 139.8170 },
                    '品川区': { lat: 35.6092, lng: 139.7301 },
                    '目黒区': { lat: 35.6433, lng: 139.6979 },
                    '大田区': { lat: 35.5614, lng: 139.7166 },
                    '世田谷区': { lat: 35.6464, lng: 139.6533 },
                    '渋谷区': { lat: 35.6586, lng: 139.7016 },
                    '中野区': { lat: 35.6896, lng: 139.6656 },
                    '杉並区': { lat: 35.7000, lng: 139.6369 },
                    '豊島区': { lat: 35.7296, lng: 139.7156 },
                    '北区': { lat: 35.7539, lng: 139.7340 },
                    '荒川区': { lat: 35.7362, lng: 139.7830 },
                    '板橋区': { lat: 35.7511, lng: 139.6937 },
                    '練馬区': { lat: 35.7353, lng: 139.6532 },
                    '足立区': { lat: 35.7752, lng: 139.8043 },
                    '葛飾区': { lat: 35.7447, lng: 139.8766 },
                    '江戸川区': { lat: 35.7068, lng: 139.8683 },
                    '八王子市': { lat: 35.6559, lng: 139.3238 },
                    '立川市': { lat: 35.7142, lng: 139.4036 },
                    '武蔵野市': { lat: 35.7181, lng: 139.5637 },
                    '三鷹市': { lat: 35.6836, lng: 139.5598 },
                    '府中市': { lat: 35.6697, lng: 139.4775 },
                    '調布市': { lat: 35.6517, lng: 139.5434 },
                    '町田市': { lat: 35.5468, lng: 139.4269 },
                    '小金井市': { lat: 35.6999, lng: 139.5035 },
                    '小平市': { lat: 35.7284, lng: 139.4775 },
                    '日野市': { lat: 35.6713, lng: 139.3957 },
                    '東村山市': { lat: 35.7544, lng: 139.4681 },
                    '国分寺市': { lat: 35.7011, lng: 139.4606 },
                    '国立市': { lat: 35.6840, lng: 139.4417 },
                    '狛江市': { lat: 35.6358, lng: 139.5785 },
                    '東大和市': { lat: 35.7453, lng: 139.4259 },
                    '清瀬市': { lat: 35.7854, lng: 139.5264 },
                    '東久留米市': { lat: 35.7585, lng: 139.5298 },
                    '武蔵村山市': { lat: 35.7543, lng: 139.3873 },
                    '多摩市': { lat: 35.6369, lng: 139.4466 },
                    '稲城市': { lat: 35.6381, lng: 139.5042 },
                    '西東京市': { lat: 35.7253, lng: 139.5384 }
                };
                
                const allNinshoData = [...ninshoAProcessed, ...ninshoBProcessed];
                
                for (const facility of allNinshoData) {
                    const baseCoord = wardCoords[facility.ward] || { lat: 35.6762, lng: 139.6503 };
                    const latOffset = (Math.random() - 0.5) * 0.015;
                    const lngOffset = (Math.random() - 0.5) * 0.018;
                    
                    facility.latitude = Math.round((baseCoord.lat + latOffset) * 100000) / 100000;
                    facility.longitude = Math.round((baseCoord.lng + lngOffset) * 100000) / 100000;
                    facility.coordinate_system = 'WGS84';
                }
                
                log('✅ 座標生成完了');
                
                // 統合データ作成
                const completeData = [...ninkaProcessed, ...allNinshoData];
                const jsonString = JSON.stringify(completeData, null, 2);
                const fileSizeKB = Math.round(jsonString.length / 1024);
                
                log(`🎉 完成！総施設数: ${completeData.length}施設`);
                log(`📄 ファイルサイズ: ${fileSizeKB}KB`);
                
                // ダウンロードリンク作成
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                document.getElementById('downloadLink').href = url;
                document.getElementById('fileSize').textContent = fileSizeKB;
                document.getElementById('downloadSection').style.display = 'block';
                
                document.getElementById('success').innerHTML = `
                    <h3>🎉 JSONファイル生成完了！</h3>
                    <p>認可保育所: ${ninkaProcessed.length}施設</p>
                    <p>認証保育所A型: ${ninshoAProcessed.length}施設</p>
                    <p>認証保育所B型: ${ninshoBProcessed.length}施設</p>
                    <p><strong>総計: ${completeData.length}施設</strong></p>
                `;
                document.getElementById('success').style.display = 'block';
                
            } catch (error) {
                log(`❌ エラー: ${error.message}`);
                console.error(error);
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        async function readFileAsShiftJIS(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const decoder = new TextDecoder('shift_jis');
                    const text = decoder.decode(arrayBuffer);
                    resolve(text);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>
</html>